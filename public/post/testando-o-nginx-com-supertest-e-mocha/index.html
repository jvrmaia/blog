<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Testando o NGINX com SuperTest e Mocha - João Maia</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Testando o NGINX com SuperTest e Mocha" />
<meta property="og:description" content="Olá,
testar a infraestrutura não é um sonho mas sim uma realidade, se você ainda não faz nada a respeito saiba que já está atrasado. Com a transformação da infraestrutura em código acabando com os processos manuais e nem sempre documentados é preciso também trazer as boas práticas do mundo de desenvolvimento de software para a infraestrutura. Graças ao Docker subir uma representação da sua infraestrutura ficou mais fácil realizar esse processo apesar de ainda não ser 100% fiel ao ambiente de produção." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.joaovrmaia.com/post/testando-o-nginx-com-supertest-e-mocha/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-03-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-03-18T00:00:00+00:00" />


		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Testando o NGINX com SuperTest e Mocha"/>
<meta name="twitter:description" content="Olá,
testar a infraestrutura não é um sonho mas sim uma realidade, se você ainda não faz nada a respeito saiba que já está atrasado. Com a transformação da infraestrutura em código acabando com os processos manuais e nem sempre documentados é preciso também trazer as boas práticas do mundo de desenvolvimento de software para a infraestrutura. Graças ao Docker subir uma representação da sua infraestrutura ficou mais fácil realizar esse processo apesar de ainda não ser 100% fiel ao ambiente de produção."/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="João Maia" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">João Maia</div>
					<div class="logo__tagline">Compartilhando conhecimento sobre tecnologia e outras coisas mais</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">Sobre</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">
				
				<span class="menu__text">Posts</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">Tags</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">Categoria</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="http://www.joaovrmaia.com">
				
				<span class="menu__text">Site pessoal</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Testando o NGINX com SuperTest e Mocha</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2020-03-18T00:00:00Z">2020-03-18</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/devops/" rel="category">devops</a>, <a class="meta__link" href="/categories/testes/" rel="category">testes</a>
	</span>
</div></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/testando-o-nginx-com-supertest-e-mocha/nginx-logo.png" alt="Testando o NGINX com SuperTest e Mocha">
		</figure><div class="content post__content clearfix">
			<p>Olá,</p>
<p>testar a infraestrutura não é um sonho mas sim uma realidade, se você ainda não faz nada a respeito saiba que já está atrasado. Com a transformação da infraestrutura em código acabando com os processos manuais e nem sempre documentados é preciso também trazer as boas práticas do mundo de desenvolvimento de software para a infraestrutura. Graças ao Docker subir uma representação da sua infraestrutura ficou mais fácil realizar esse processo apesar de ainda não ser 100% fiel ao ambiente de produção.</p>
<p>Muitos já devem ter usado ou usam o <a href="https://www.nginx.com/">NGINX</a> como balanceador de carga da sua infraestrutura ou até para outros recursos mais avançados que ele permite com suas integrações de plugins, por exemplo, o projeto <a href="https://openresty.org/en/">OpenResty</a>. Se o seu NGINX tem diversos recursos e configurações particulares é preciso que você tenha controle disso e apenas comentar na configuração do arquivo talvez não seja o suficiente caso se lembre de fazer isso. Com testes conseguimos garantir melhor o entendimento e propósito dessas configurações. Então, como escrever testes para isso?</p>
<p>Procurando alguma solução para execução de testes de chamadas HTTP acabei encontrando como opção o <a href="https://github.com/visionmedia/supertest">SuperTest</a> que é feito em JavaScript e podemos facilmente executar no nosso ambiente de integração contínua com <a href="https://nodejs.org/en/">Node.js</a>. Apesar de, à primeira, vista ele ser um framework voltado ao <a href="https://expressjs.com/pt-br/">Express.js</a>, ele pode ser executado para testar qualquer aplicação Web sem se importar com o que seja, examente o que precisamos.</p>
<p>Além disso, precisamos de alguma ferramenta que vai gerenciar as execuções dos testes e fazer as asserções e gerar o relatório final, nessa caso, escolhi o <a href="https://mochajs.org/">Mocha</a> que já tinha familiaridade trabalhando em projetos de Node.js no passado. Quem já programou em <a href="https://www.ruby-lang.org/pt/">Ruby</a> e escreveu testes com <a href="https://rspec.info/">RSpec</a> vai achar bem parecido.</p>
<p>Como forma de validar essa solução fiz um pequeno <a href="https://github.com/jvrmaia/nginx-tests-with-supertest">projeto</a> para validação das ferramentas e conceito do que buscava. No desenho abaixo mostro como vai funcionar a estrutura do projeto. Explicando os componentes:</p>
<ul>
<li>Test runner: é o Docker que vai rodar a bateria de testes com o SuperTest;</li>
<li>Gateway: é o NGINX (Docker) que queremos testar que está fazendo um papel de proxy reverso; e</li>
<li>Echo: uma aplicação que responde uma resposta padrão para simular um backend.</li>
</ul>
<pre tabindex="0"><code>+-----------------+              +-----------------+                   +------------------+
|                 |              |                 |                   |                  |
|  TEST           |              |                 |                   |                  |
|                 +--------------&gt; GATEWAY (NGINX) +-------------------&gt; ECHO (BACKEND)   |
|  RUNNER         |              |                 |                   |                  |
|                 |              |                 |                   |                  |
+-----------------+              +-----------------+                   +------------------+
</code></pre><h1 id="infraestrutura-dos-testes">Infraestrutura dos testes</h1>
<p>Agora que já sabemos a estutura da infraestrutura que vamos testar precimos tornar ela real. A escolha foi usar <a href="https://docs.docker.com/compose/">docker-compose</a> que é uma ferramenta muito usada em ambiente de desenvolvimento hoje para subir o ambiente completo:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.2&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">gateway</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./gateway</span><span class="w">
</span><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">echo</span><span class="w">
</span><span class="w">    </span><span class="nt">links</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">echo</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">8080</span><span class="p">:</span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">fake-vpc</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">echo</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hashicorp/http-echo</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span>-<span class="l">listen=:3000 -text=&#34;hello world&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">3000</span><span class="p">:</span><span class="m">3000</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">fake-vpc</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">test-runner</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./tests</span><span class="w">
</span><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">GATEWAY_HOST=gateway</span><span class="w">
</span><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">gateway</span><span class="w">
</span><span class="w">    </span><span class="nt">links</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">gateway</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">fake-vpc</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">fake-vpc</span><span class="p">:</span><span class="w">
</span></code></pre></div><p>Não temos novidades aqui para quem já está acostumado com o uso, declaramos nossos 3 serviços e fizemos as configurações devidas de rede para resolverem por nome dentro da rede virtualizada pelo Docker e exportamos as portas necessárias para testar de forma local o SuperTest ou simplesmente um <code>curl</code>.</p>
<h1 id="gateway">Gateway</h1>
<p>O nosso gateway não tem muitas customizações, basicamente adicionei o proxy reverso para o <code>echo</code> e adicionei uma configuração para <code>gzip</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">gzip</span>  <span class="no">on</span><span class="p">;</span>
</code></pre></div><p>Adicionando o <code>echo</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

    <span class="c1">#charset koi8-r;
</span><span class="c1"></span>    <span class="c1">#access_log  /var/log/nginx/host.access.log  main;
</span><span class="c1"></span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">root</span>   <span class="s">/usr/share/nginx/html</span><span class="p">;</span>
        <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/echo</span> <span class="p">{</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://echo:3000</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">//</span> <span class="s">omitido</span> <span class="s">o</span> <span class="s">restante</span>
<span class="err">}</span>
</code></pre></div><h1 id="os-testes">Os testes</h1>
<p>Não tem muito mistério, primeiro você tem que inicializar o executor do SuperTest para fazer as chamadas HTTP no Gateway e por fim descrever os testes usando o Mocha:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;supertest&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">GATEWAY_HOST</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GATEWAY_HOST</span> <span class="o">||</span> <span class="s1">&#39;http://localhost:8080&#39;</span>
<span class="kr">const</span> <span class="nx">runner</span> <span class="o">=</span> <span class="nx">request</span><span class="p">(</span><span class="nx">GATEWAY_HOST</span><span class="p">);</span>


<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Gateway tests&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Root path must return HTTP/200&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">runner</span>
            <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Non existis path must return HTTP/404&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">runner</span>
            <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/404&#39;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Headers configurations&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Server must be NGINX&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">runner</span>
                <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="s1">&#39;nginx/1.17.9&#39;</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Content-Type must be HTML&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">runner</span>
                <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">],</span> <span class="s1">&#39;text/html&#39;</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Connection must be closed&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">runner</span>
                <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">connection</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Content encoding must be gzip&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">runner</span>
                <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">[</span><span class="s1">&#39;content-encoding&#39;</span><span class="p">],</span> <span class="s1">&#39;gzip&#39;</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="p">});</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Application path&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;/echo must return to application&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">runner</span>
                <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/echo&#39;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="s1">&#39;hello world\n&#39;</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="p">})</span>

<span class="p">});</span>
</code></pre></div><p>Olhando em detalhes para entender melhor:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;Content encoding must be gzip&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">runner</span>
        <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">expect</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">[</span><span class="s1">&#39;content-encoding&#39;</span><span class="p">],</span> <span class="s1">&#39;gzip&#39;</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>O nosso executor, no caso a variável <code>runner</code>, executa uma chamad HTTP/GET na raíz do nosso Gateway e de resultado esperamos que o <code>Content-Encoding</code> seja <code>gzip</code> como bem definimos no arquivo de configuração e por fim fechamos a <code>Promise</code> do teste com o <code>.end(done)</code>. Detalhe importante, lembre-se que as chaves dos valores do <code>Header</code> não são sensíveis ao caso, o que isso significa, você pode enviar sua requisição escrito <code>Content-Encoding</code> ou <code>content-encoding</code> que não faz diferença, são tratados iguais. Afim de evitar confusão, o SuperTest padroniza tudo no minúsculo.</p>
<h1 id="colocando-no-ci">Colocando no CI</h1>
<p>Tenho usado o Circle CI para isso pois é fácil o uso e para projetos abertos não tem custo e usamos ele na empresa. Acho ele bem completo para ajudar nisso mas acho que falta melhorar na parte de granularidade de acessos e permissões da organização e projetos. Aproveitando a brincadeira coloquei de quebra um teste no CI para ver ser o Dockerfile tá seguindo as boas práticas também com o <a href="https://github.com/hadolint/hadolint">Hadolint</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">2.1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">checkout</span><span class="w">
</span><span class="w">
</span><span class="w">            </span>- <span class="nt">run</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile lint &#39;gateway&#39;</span><span class="w">
</span><span class="w">                </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">                    </span><span class="l">docker run --rm -i hadolint/hadolint &lt; ./gateway/Dockerfile</span><span class="w">
</span><span class="w">
</span><span class="w">            </span>- <span class="nt">run</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Test &#39;gateway&#39; image</span><span class="w">
</span><span class="w">                </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">                    docker-compose up -d echo gateway
</span><span class="sd">                    docker-compose up test-runner</span><span class="w">                    
</span></code></pre></div><p>Será que funcionou? Veja a imagem do CI:</p>
<p><img src="/img/testando-o-nginx-com-supertest-e-mocha/circleci.png" alt="Circle CI"></p>
<p>Acho que era isso que queria passar nesse artigo, até o próximo.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/devops/" rel="tag">devops</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/teste/" rel="tag">teste</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/nginx/" rel="tag">nginx</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/supertest/" rel="tag">supertest</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/node/" rel="tag">node</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="João Maia avatar" src="/img/avatar.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About João Maia</span>
	</div>
	<div class="authorbox__description">
		Pessoa que resolve problemas com o uso de softwares
	</div>
</div>


<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-hugo" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2022 João Maia.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>