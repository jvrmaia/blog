<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Vamos falar de DNS? - João Maia</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Vamos falar de DNS?" />
<meta property="og:description" content="Olá,
você já deve ter visto essa sigla alguma vez na sua vida. Talvez já tenha até configurado isso na sua máquina sem bem entender direito para que serve, né? Nesse texto pretendo fazer um resumão de DNS para ajudar qualquer pessoa que queira entender mais sobre o assunto. A definição formal tá aqui na rfc1034, sobre a implementação rfc1035 e para quem tiver mais curiosidade a lista completa.
Se ficarem dúvidas ou tiverem sugestões de continuidade no assunto é só comentar no fim do artigo ou entrar em contato comigo por algum meio dos informados na página inicial do blog." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.joaovrmaia.com/post/vamos-falar-de-dns/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-08-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-08-28T00:00:00+00:00" />


		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Vamos falar de DNS?"/>
<meta name="twitter:description" content="Olá,
você já deve ter visto essa sigla alguma vez na sua vida. Talvez já tenha até configurado isso na sua máquina sem bem entender direito para que serve, né? Nesse texto pretendo fazer um resumão de DNS para ajudar qualquer pessoa que queira entender mais sobre o assunto. A definição formal tá aqui na rfc1034, sobre a implementação rfc1035 e para quem tiver mais curiosidade a lista completa.
Se ficarem dúvidas ou tiverem sugestões de continuidade no assunto é só comentar no fim do artigo ou entrar em contato comigo por algum meio dos informados na página inicial do blog."/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-61280444-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="João Maia" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">João Maia</div>
					<div class="logo__tagline">Compartilhando conhecimento sobre tecnologia e outras coisas mais</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">Sobre</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">
				
				<span class="menu__text">Posts</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">Tags</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">
				
				<span class="menu__text">Categoria</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="http://www.joaovrmaia.com">
				
				<span class="menu__text">Site pessoal</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Vamos falar de DNS?</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2020-08-28T00:00:00Z">2020-08-28</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/rede-de-computadores/" rel="category">rede de computadores</a>
	</span>
</div></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/img/vamos-falar-de-dns/dns.png" alt="Vamos falar de DNS?">
		</figure><div class="content post__content clearfix">
			<p>Olá,</p>
<p>você já deve ter visto essa sigla alguma vez na sua vida. Talvez já tenha até configurado isso na sua máquina sem bem entender direito para que serve, né? Nesse texto pretendo fazer um resumão de DNS para ajudar qualquer pessoa que queira entender mais sobre o assunto. A definição formal tá aqui na <a href="https://www.ietf.org/rfc/rfc1034.txt">rfc1034</a>, sobre a implementação <a href="https://www.ietf.org/rfc/rfc1035.txt">rfc1035</a> e para quem tiver mais curiosidade a <a href="https://en.wikipedia.org/wiki/Domain_Name_System#RFC_documents">lista completa</a>.</p>
<p>Se ficarem dúvidas ou tiverem sugestões de continuidade no assunto é só comentar no fim do artigo ou entrar em contato comigo por algum meio dos informados na página inicial do blog.</p>
<h1 id="o-que-é-dns">O que é DNS?</h1>
<h2 id="introdução-a-rede-de-computadores">Introdução a rede de computadores</h2>
<p>Vamos falar de forma breve e direta para nivelar todo mundo aqui. Para que seja possível você ler esse artigo é preciso que o servidor onde tem esse site hospedado te envie os dados dele para o seu navegador renderizar e ler. Para que isso ocorra é preciso que um conjunto de protocolos sejam respeitados para que essa entrega aconteça e ainda assim pode falhar e um desses protocolos é o DNS. Vamos fazer um pequeno paralelo para ficar mais claro. Por conta da pandemia estamos fazendo mais compras online que o normal. Com isso, para garantir que sua compra chegue até você é coletado de você algumas informações a respeito de onde deve ser feita a entrega. Essas informações fazem parte da exigência da transportadora que vai receber o pacote e cuidar que ele chegue até você. Tudo dando certo o pacote chega até você sem problemas mas pode ser que aconteça de algum acidente acontecer no meio do caminho e o pacote não chegar, assim como sua internet pode cair antes do site carregar.</p>
<p>Da <a href="https://pt.wikipedia.org/wiki/Modelo_OSI">Wikipédia</a>:</p>
<blockquote>
<p>O Modelo OSI (acrônimo do inglês Open System Interconnection) é um modelo de rede de computador referência da ISO dividido em camadas de funções, criado em 1971 e formalizado em 1983, com objetivo de ser um padrão, para protocolos de comunicação entre os mais diversos sistemas em uma rede local (Ethernet), garantindo a comunicação entre dois sistemas computacionais (end-to-end).</p>
</blockquote>
<p><img src="/img/vamos-falar-de-dns/modelo_osi.png" alt="Modelo OSI"></p>
<p>Detalhando essas camadas:</p>
<ol>
<li><strong>Física</strong>: Transmissão e recepção dos bits brutos através do meio físico de transmissão;</li>
<li><strong>Enlace</strong>: Detecção de erros;</li>
<li><strong>Rede</strong>: Roteamento de pacotes em uma ou várias redes;</li>
<li><strong>Transporte</strong>: Oferece métodos para a entrega de dados ponto-a-ponto;</li>
<li><strong>Sessão</strong>: Negociação e conexão com outros nós, analogia;</li>
<li><strong>Apresentação</strong>: Formatação dos dados, conversão de códigos e caracteres; e</li>
<li><strong>Aplicação</strong>: Funções especialistas (transferência de arquivos, envio de e-mail, terminal virtual).</li>
</ol>
<p>Voltando para nossa analogia da compra, o site que você fez a compra seria a camda de aplicação, na camada de apresentação os seus dados vão ser formatadas para ficarem de acordo com a transportadora que por sua vez entre na camada de sessão onde ela começa a fazer parte desse fluxo da entreta. Na camada de transporte vamos definir qual vai ser a modalidade de entrega da transportadora que vamos usar e a camada de rede seria a inteligência de logistica dessa empresa e por fim na camada de enlace teriamos as vias de transporte e na física o transportador.</p>
<p>Tá bom, e onde entra o DNS nisso? Já reparou que no geral sempre ao cadastrar um endereço podemos dar apelidos para eles ou eles assumem que a pessoa fazendo a compra é o apelido? Esse ato de apelidar é o DNS. Imagine que você more com mais pessoas, toda a parte formal do seu endereço vai ser igual para você e demais pessoas que moram com você e por isso apelidos são importantes, assim podemos garantir que sua entrega vai ser feita a você e não para outra pessoa do seu apartamento ou casa.</p>
<h2 id="utilidades-do-dns">Utilidades do DNS</h2>
<p>Até então ao que parece o DNS serve apenas para dar apelidos a entidades mas não é só isso. Vamos nesse artigo explorar três utilidades do DNS:</p>
<ol>
<li>Nomear servidores;</li>
<li>Distribuição de carga; e</li>
<li>Descoberta de serviços.</li>
</ol>
<h3 id="nomear-servidores">Nomear servidores</h3>
<p>Essa é uma funcionalidade que já conversamos aqui um pouco. Vamos explorar um pouco mais essa funcionalidade, vamos entender um pouco mais sobre o <code>google.com</code> e para isso vamos usar o comando <code>host</code> do Linux:</p>
<pre tabindex="0"><code>$ host google.com
google.com has address 172.217.29.110
google.com has IPv6 address 2800:3f0:4004:807::200e
google.com mail is handled by 30 alt2.aspmx.l.google.com.
google.com mail is handled by 20 alt1.aspmx.l.google.com.
google.com mail is handled by 10 aspmx.l.google.com.
google.com mail is handled by 50 alt4.aspmx.l.google.com.
google.com mail is handled by 40 alt3.aspmx.l.google.com.
</code></pre><p>Veja que interessante, ele converte o DNS do Google em IP e ainda tem outra informações interessantes. Repare que ele forneceu duas versões de IP. Uma pausa para esse assunto, hoje temos duas versões do protocolo IP em uso na Internet, o <a href="https://pt.wikipedia.org/wiki/IPv4">IPv4</a> e <a href="https://pt.wikipedia.org/wiki/IPv6">IPv6</a>, por conta de uma limitação de combinações diferentes de IP e a explosão de dispositivos e serviços que hoje conseguem ter interface com a rede de computadores o protocolo se tornou limitado. Com isso, surgiu o IPv6 que veio atender a essa nova demanda de IPs. Além disso, ele também identificou que nesse domínio do Google tem um serviços de email como podemos ver. Olhe agora como podemos explorar ainda mais o <code>host</code> no estudo do domínio do Google:</p>
<pre tabindex="0"><code>$ host -a google.com
Trying &quot;google.com&quot;
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 43764
;; flags: qr rd ra; QUERY: 1, ANSWER: 12, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;google.com.			IN	ANY

;; ANSWER SECTION:
google.com.		296	IN	AAAA	2800:3f0:4004:808::200e
google.com.		111294	IN	NS	ns1.google.com.
google.com.		111294	IN	NS	ns3.google.com.
google.com.		111294	IN	NS	ns2.google.com.
google.com.		111294	IN	NS	ns4.google.com.
google.com.		2	IN	SOA	ns1.google.com. dns-admin.google.com. 326790814 900 900 1800 60
google.com.		272	IN	A	172.217.29.110
google.com.		443	IN	MX	40 alt3.aspmx.l.google.com.
google.com.		443	IN	MX	30 alt2.aspmx.l.google.com.
google.com.		443	IN	MX	20 alt1.aspmx.l.google.com.
google.com.		443	IN	MX	10 aspmx.l.google.com.
google.com.		443	IN	MX	50 alt4.aspmx.l.google.com.

Received 298 bytes from 127.0.0.53#53 in 74 ms
</code></pre><p>Veja que interessantes quanta informação a mais temos, nesse momento vamos olhar apenas essas:</p>
<pre tabindex="0"><code>google.com.		111294	IN	NS	ns1.google.com.
google.com.		111294	IN	NS	ns3.google.com.
google.com.		111294	IN	NS	ns2.google.com.
google.com.		111294	IN	NS	ns4.google.com.
</code></pre><p>Vamos falar sobre isso nos próximos tópicos mas esses são os servidores do Google que fazem o papel de serviço de DNS deles, ou seja, são essas máquinas que sabem traduzir tudo que for <code>*.google.com</code> em um IP.</p>
<p>Curiosamente rodei o primeiro comando mais uma vez depois de um certo espaço de tempo e veja o resultado:</p>
<pre tabindex="0"><code>$ host google.com
google.com has address 216.58.222.78
google.com has IPv6 address 2800:3f0:4004:804::200e
google.com mail is handled by 10 aspmx.l.google.com.
google.com mail is handled by 50 alt4.aspmx.l.google.com.
google.com mail is handled by 20 alt1.aspmx.l.google.com.
google.com mail is handled by 40 alt3.aspmx.l.google.com.
google.com mail is handled by 30 alt2.aspmx.l.google.com.
</code></pre><p>Repare que o IP mudou e isso nos leva ao nosso próximo tópico! =)</p>
<h3 id="distribuição-de-carga">Distribuição de carga</h3>
<p>Expor um servidor ao seu público pode ser algo complicado se o público aumentar de forma descontrolada e seu processamento por requisição não for extremamente rápido ou fazer atualizações nesse sem impactar o público são coisas complicadas de serem feitas por conta desse acesso direto. Um das boas práticas de arquitetura de software é colocar um distribuidor de carga na frente de serviços, são exemplos disso o <a href="https://www.apache.org/">Apache</a>, <a href="https://www.nginx.com/">NGINX</a> e <a href="http://www.haproxy.org/">HAProxy</a> de opções que você pode executar em sua infraestrutura de forma livre e outras soluções que já serão amarradas ao seu provedor de nuvem, por exemplo, <a href="https://aws.amazon.com/pt/elasticloadbalancing/">Elastic Load Balancing</a> da AWS, <a href="https://cloud.google.com/load-balancing">Cloud Load Balancing</a> do Google Cloud e <a href="https://azure.microsoft.com/pt-br/services/load-balancer">Load Balancer</a> da Azure. Todas essas soluções vão criar para você uma interface única de comunicação com seus servidores.</p>
<p>Vamos imaginar um cenário de ecommerce pequeno, minhaloja.com, com poucos acessos durante o ano e com uma máquina apenas consiga atender a demanda. Então, é época de Black Friday e nesse momento em especial do ano o acesso do site aumenta muito e um servidor não da conta e para isso o time de infraestrutura precisa colocar duas novas instâncias para sustentar a carga dado o estudo de capacidade feito durante o ano e tipo de hardware disponível. Como vimos na parte anterior o Google consegue responder diferentes IPs para o mesmo domínio, isso acontece pois o DNS dele está fazendo o papel de distribuir carga entre dois servidores. Para fazer isso no nosso ecommerce vamos inserir o NGINX na nossa arquitetura. Na <em>Arquitetura Normal</em> vamos ter apenas o NGINX e uma instância do ecommerce e na <em>Arquitetura Black Friday</em> vamos ter o NGINX com três instâncias do ecommerce, veja imagem abaixo. Qual a nossa estratégia com essa solução? Vamos delegar o DNS <code>minhaloja.com</code> ao nosso servidor de NGINX pois com isso ele fica delegado em distribuir a carga entre os servidores do ecommerce pois apesar de possível não seria o ideal aqui de fazer isso apenas com o DNS.</p>
<p><img src="/img/vamos-falar-de-dns/arquitetura_normal.png" alt="Arquitetura Normal"> <img src="/img/vamos-falar-de-dns/arquitetura_black_friday.png" alt="Arquitetura Black Friday"></p>
<h3 id="descoberta-de-serviços">Descoberta de serviços</h3>
<p>Outro recurso muito interessante e extremamente útil nos tempos atuais com sistemas distribuídos é o uso do DNS para descoberta de serviços. Vamos voltar no caso anterior do ecommerce e agora introduzir um banco de dados na arquitetura que foi omitido na parte anterior. Imagina o problema que é se todos os três serviços apenas se comunicarem através de configuração de IP fixo, um troca de servidor programada ou não poderia causar algum problema no sistema por indisponibilidade de algum desses serviços devido a troca do IP configurado. Agora, vamos imaginar um quarto serviço nessa arquitetura que você possa ir nele e registrar quem é você, quase um cartório. Então, o nosso banco de dados poderia, por exemplo, se registrar como <code>db.internal.minhaloja.com</code> ao IP <code>10.20.30.40</code> assim nossa aplicação web só vai precisar saber esse domínio cadastrado, pois sempre que ele for interagir com o banco de dados ele vai perguntar a esse serviço central que é <code>db.internal.minhaloja.com</code> e caso o IP mude não será problema. Um ferramenta que faz isso e você pode estudar a respeito é o <a href="https://www.consul.io/">Consul</a> da <a href="https://www.hashicorp.com/">HashiCorp</a>.</p>
<h1 id="como-o-dns-funciona">Como o DNS funciona?</h1>
<h2 id="resolvendo-dns-no-linux">Resolvendo DNS no Linux</h2>
<p>Vamos supor que você está no Linux e vai fazer acesso de algum site no seu navegador, esse blog, por exemplo. Como já sabemos o <code>blog.joaovrmaia.com</code> é apenas um apelido para abstrair algum IP na rede mundial de computadores, como já diria o Jefferson da <a href="https://www.linuxtips.io/">LinuxTips</a>, e vamos precisar desse IP para chegar lá e trocar dados com ele.</p>
<p>No Linux vai ocorrer a chamada <a href="https://man7.org/linux/man-pages/man3/gethostbyname.3.html"><code>gethostbyname()</code></a> quem vai começar a jornada pela resolução desse IP. Essa nossa chamada vai gerar uma consulta que será feita na Internet mas como nossa máquina lança essa consulta na Internet? No nosso sistema temos um arquivo, <code>/etc/resolv.conf</code>, que é gerenciado pelo sistema operacional e alimentado pela sua rede caso não tenha feito alguma modificação manual nele. Os valores desse arquivo no geral vem através do serviço de <a href="https://pt.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a> que podemos falar a respeito em outro momento. Veja como é o arquivo:</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf"># This file is managed by man:systemd-resolved(8). Do not edit.
#
# This is a dynamic resolv.conf file for connecting local clients to the
# internal DNS stub resolver of systemd-resolved. This file lists all
# configured search domains.
#
# Run &quot;resolvectl status&quot; to see details about the uplink DNS servers
# currently in use.
#
# Third party programs must not access this file directly, but only through the
# symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a different way,
# replace this symlink by a static file or a different symlink.
#
# See man:systemd-resolved.service(8) for details about the supported modes of
# operation for /etc/resolv.conf.

nameserver 127.0.0.53
options edns0
search br
</code></pre><p>Então, nosso DNS está rodando para esse IP <code>127.0.0.53</code> que na verdade é uma abstração do <a href="https://pt.wikipedia.org/wiki/Systemd">systemd</a>. Então, vamos executar o comando sugerido no arquivo de configuração:</p>
<pre tabindex="0"><code>$ resolvectl status
Global
       LLMNR setting: no                  
MulticastDNS setting: no                  
  DNSOverTLS setting: no                  
      DNSSEC setting: no                  
    DNSSEC supported: no                  
          DNSSEC NTA: 10.in-addr.arpa     
                      16.172.in-addr.arpa 
                      168.192.in-addr.arpa
                      17.172.in-addr.arpa 
                      18.172.in-addr.arpa 
                      19.172.in-addr.arpa 
                      20.172.in-addr.arpa 
                      21.172.in-addr.arpa 
                      22.172.in-addr.arpa 
                      23.172.in-addr.arpa 
                      24.172.in-addr.arpa 
                      25.172.in-addr.arpa 
                      26.172.in-addr.arpa 
                      27.172.in-addr.arpa 
                      28.172.in-addr.arpa 
                      29.172.in-addr.arpa 
                      30.172.in-addr.arpa 
                      31.172.in-addr.arpa 
                      corp                
                      d.f.ip6.arpa        
                      home                
                      internal            
                      intranet            
                      lan                 
                      local               
                      private             
                      test                

...

Link 3 (wlp4s0)
      Current Scopes: DNS                      
DefaultRoute setting: yes                      
       LLMNR setting: yes                      
MulticastDNS setting: no                       
  DNSOverTLS setting: no                       
      DNSSEC setting: no                       
    DNSSEC supported: no                       
  Current DNS Server: fe80::96ea:eaff:feb5:aa35
         DNS Servers: 192.168.15.1             
                      fe80::96ea:eaff:feb5:aa35
          DNS Domain: ~.                       
                      br

...
</code></pre><p>Omitindo algumas partes esse são nossos reais servidores de DNS: 192.168.15.1 e fe8a0::96ea:eaff:feb5:aa35 nas duas versões de IP. Esse valor é do meu roteador e provedor de Internet que é o segundo passo nessa jornada para buscar o IP do meu blog. Antes de continuar a jornada, teria como eu evitar todo esse caminho em busca do IP? Algumas vez você já tenha passado por problemas de DNS em algum lugar e precisou colocar o DNS de forma manual na sua máquina, para isso precisou apenas editar o <code>/etc/hosts</code> correto? Como o sistema sabe como dele deve buscar ali? Existe outro recurso no nosso sistema que diz a prioridade de onde buscar essa informação, é o <a href="https://man7.org/linux/man-pages/man5/nsswitch.conf.5.html"><code>nsswitch</code></a>:</p>
<pre tabindex="0"><code># /etc/nsswitch.conf
#
# Example configuration of GNU Name Service Switch functionality.
# If you have the `glibc-doc-reference' and `info' packages installed, try:
# `info libc &quot;Name Service Switch&quot;' for information about this file.

passwd:         files systemd
group:          files systemd
shadow:         files
gshadow:        files

hosts:          files mdns4_minimal [NOTFOUND=return] dns
networks:       files

protocols:      db files
services:       db files
ethers:         db files
rpc:            db files

netgroup:       nis
</code></pre><p>Como podemos ver em <code>hosts:          files mdns4_minimal [NOTFOUND=return] dns</code> o primeiro local a ser consultado é o o arquivo do sistema. Vamos fazer um teste! Vou editar no <code>/etc/hosts</code> o endereço do meu blog para localhost.</p>
<pre tabindex="0"><code>$ ping blog.joaovrmaia.com
PING jvrmaia.github.io (185.199.110.153) 56(84) bytes of data.
64 bytes from 185.199.110.153 (185.199.110.153): icmp_seq=1 ttl=56 time=20.7 ms
...
$ vim /etc/hosts
$ ping blog.joaovrmaia.com
PING localhost (127.0.0.1) 56(84) bytes of data.
64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.061 ms
...
</code></pre><p>Agora, já sabemos como nasce a requisição para resolver um nome pelo DNS. Veja bem, olhando o seu <code>/etc/hosts</code>, reparou algo?</p>
<pre tabindex="0"><code>127.0.0.1	localhost 
127.0.1.1	avell

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre><p>Se consultar no <a href="https://pt.wikipedia.org/wiki/Man_(Unix)"><code>man pages</code></a> vai ver que depois da informação do IP podemos colocar vários nomes. Então, podemos imaginar que temos uma <a href="https://en.wikipedia.org/wiki/Key%E2%80%93value_database">banco de dados chave-valor</a> que a chave é o IP e o valor é uma lista de nomes ou que cada nome se torna uma chave e o valor é o IP. A implementação aqui não importa no momento mas podemos entender que existe um conceito de banco de dados. Também podemos imaginar que o mesmo conceito se aplica na sequência da nossa consulta ao se propagar pela Internet. Então, podemos imaginar que o DNS é o maior e mais antigo banco de dados distribuído em execução.</p>
<h2 id="desenhando-a-ideia-da-implementação">Desenhando a ideia da implementação</h2>
<p>Essa consulta do DNS precisa de alguma forma ser propagada, por exemplo, quando vamos abrir um site no geral fazemos um acesso <a href="https://pt.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a>/<a href="https://pt.wikipedia.org/wiki/Hyper_Text_Transfer_Protocol_Secure">HTTPS</a> na porta 80/443 do protocolo <a href="https://pt.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a>. No caso do DNS, o processo é diferente pois ele usa o protocolo <a href="https://pt.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> na porta 53. Podemos acreditar que a escolha foi feita pela velocidade e baixo risco no caso de falha e os motivos disso podemos ter em algum outro aritgo discutindo sobre TCP x UDP. Agora que já temos um conhecimento de como essa consulta é feita, vamos voltar na estrutura dos dados do DNS.</p>
<p><img src="/img/vamos-falar-de-dns/dns-tree.png" alt="DNS Tree"></p>
<p>Como podemos ver o DNS tem um estrutura de árvore onde tudo começa na <code>root zone</code> que são os grandes <a href="https://pt.wikipedia.org/wiki/Fornecedor_de_acesso_%C3%A0_internet">ISP&rsquo;s</a> que fazem a composição principal da Internet e abaixo deles temos alguns domínios conhecidos por muitos de nós como o <code>.com</code> e <code>.br</code>. Podemos explorar ainda mais isso, por exemplo, vamos ver o meu blog que é <code>blog.joaovrmaia.com</code>. Então, temos o seguinte caminho: root zone, .com, .joaovrmaia e por fim blog. São três saltos na árvore que precisam ser feitos para chegar na folha da árvore que representa meu IP. Agora que sabemos dessa estrutura em árvore seria interessante ser perguntar o motivo disso, vamos considerar duas vertentes: algoritmos e segurança.</p>
<p>Vamos começar pelo ponto de vista de segurança. Imagina o caos se todos tivessem a liberdade de sair criando domínio como bem entender? Vamos analisar o meu caso novamente usando o blog. Meu blog é <code>blog.joaovrmaia.com</code>, o blog nada mais é que um apelido para o <a href="https://pages.github.com/">Github Pages</a> da minha conta no <a href="https://github.com/">Github</a> que administro na <a href="https://aws.amazon.com/pt/">AWS</a> usando o serviço de DNS deles chamado <a href="https://aws.amazon.com/pt/route53/">Route53</a>. Esse meu domínio <code>joaovrmaia.com</code> hoje está na AWS porque ao comprar no <code>register.com</code> deleguei a responsabilidade da resolução dele para a AWS que por sua vez roda por baixo do <code>.com</code> que está por baixo dos <code>root servers</code>. Então, é assim que temos uma primeira visão de segurança pois cada nível dessa árvore do DNS a responsabilidade está associada a alguma entidade que se torna responsável pelo que executa no domínio mas em caso de infrações e não retratamento a camada superior pode interferir.</p>
<p>Agora vamos ver a questão do algoritmo. Eu tinha dado a ideia de um banco de dados chave-valor mas imagine todos os domínios da Internet dentro desse banco, inviável, né? Então, esse modelo de árvore e ser distribuído começa a fazer ainda mais sentido pois a carga será bem mais dividida. Vamos exemplorar dois exemplos para entender melhor, no primeiro caso queremos em uma rede local acessar outro serviço. Supondo que estou no <code>srv01.minharede.local</code> e quero chegar no <code>srv04.minharede.local</code> é bem simples pois a nossa requisição de DNS vai depender apenas do ambiente local, ou seja, precisamos ir apenas um nível acima na árvore para descobrir o IP. Agora, no segundo exemplo vamos imaginar que você está no seu PC pessoal em casa querendo compartilhar algo com alguém via <a href="https://ngrok.com/">ngrok</a>, por exemplo. Essa sua requisição vai ter que subir mais passos na árvore e uma hora voltar, imagina o quanto de possibilidades são evitas pelo simples fato do domínio ser <!-- raw HTML omitted -->.ngrok.io, ou seja, antes de chegar nos serviços internos do ngrok um universo de possibilidades vão ser removidas com as restrições do .io e .ngrok.</p>
<h2 id="como-funciona-na-prática">Como funciona na prática</h2>
<p>Como já tinha dito a borda da Internet se conversa através de grandes ISP. Essas entidades são os nossos <code>Root DNS servers</code> que tem como responsabilidade saber quem são nossos <code>Top-level domain (TLD) servers</code> que são as entidades responsáveis por domínios como o .com, .org, .net e afins além de todos os países como .nr, .uk, .fr e outros, <a href="https://root-servers.org/">aqui</a> você pode visualizar os <code>Root DNS servers</code> igual na imagem abaixo os TLD servers estão nessa <a href="https://www.iana.org/domains/root/db">lista</a>. Vamos explorar um pouco mais os TLD servers observando o <a href="https://www.iana.org/domains/root/db/br.html">.br</a> e <a href="https://www.iana.org/domains/root/db/google.html">.google</a>, veja que em ambos possuem a lista de servidores de domínio que fazem a gestão do DNS e seus respectivos contados administrativo e técnico. Por fim, os TLD servers vão saber indentificar os <code>Authoritative DNS servers</code> que são os domínios que usamos, por exemplo, joaovrmaia.com. Então, nesse nível a responsabilidade de resolução do domínio passa a ser do dono saindo dessa estrutura central da Internet. Nesse nível já estamos falando de configurar DNS para hospedar um site, ter seu serviço de e-mail e afins. Podemos dizer que existe ainda mais uma camada nessa estrutura que é o <code>Local DNS server</code>, por exemplo, em ambientes coorporativos isso é bem comum de se ter um DNS interno que só funciona para as máquina da rede local para abstrair o IP para facilitar o acesso a uma impressora remota na rede ou servidor de armazenamento compartilhado.</p>
<p><img src="/img/vamos-falar-de-dns/root-dns-server-sp.png" alt="Root DNS server SP"></p>
<p>Então, agora que já sabemos a estrutura vamos imaginar o caso de você novamente em uma rede local que tem DNS interno e precisa resolver algum domínio. Nesse processo vamos dar ínicio a uma busca recursiva nessa árvore e o primeiro local a ser consultado vai ser o seu <code>Local DNS server</code>, estou considerando que não trabalhamos com caching, que por sua vez vai identificar se ele pode responder sobre aquela consulta e caso contrário redirecionar a três opções: <code>Root DNS server</code>, <code>TLD DNS server</code> ou <code>Authoritative DNS server</code>, dependendo da sua consulta.</p>
<h3 id="recebendo-a-resposta-da-sua-consulta">Recebendo a resposta da sua consulta</h3>
<p>Agora que já sabemos muito mais a respeito da estrutura e propagação da requisição da resolução de domínio vamos entender as resposas que recebemos que nada mais é que um tupla com quatro valores: <code>Name</code>, <code>Value</code>, <code>Type</code> e <code>TTL</code>. O Type vai definir que resposta vamos obter em Name e Value, por exemplo, se você apenas consultou qual é o IP de blog.joaovrmaia.com o Name vai conter <code>blog.joaovrmaia.com</code> e o Value um IP, se o Type for A o valor vai ser IPv4 e se for AAA vai ser IPv6. Se o Type for NS ele vai responder quem é o Authoritative DNS server daquele domínio, para o caso de CNAME o apelido daquele domínio e por fim MX vai dizer quem é servidor de email daquele domínio.</p>
<p>Lista completa de tipos:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Significado</th>
<th>Valor</th>
</tr>
</thead>
<tbody>
<tr>
<td>SOA</td>
<td>Authority</td>
<td>Parâmetros da zona</td>
</tr>
<tr>
<td>A</td>
<td>IPv4</td>
<td>32 bits</td>
</tr>
<tr>
<td>AAAA</td>
<td>IPv6</td>
<td>128 bits</td>
</tr>
<tr>
<td>MX</td>
<td>Mail exchange</td>
<td>Domínio a ser aceito o email</td>
</tr>
<tr>
<td>NS</td>
<td>Name server</td>
<td>Servidor DNS do domínio</td>
</tr>
<tr>
<td>CNAME</td>
<td>Canonical Name</td>
<td>Apelido</td>
</tr>
<tr>
<td>PTR</td>
<td>Pointer</td>
<td>Apelido para IP</td>
</tr>
<tr>
<td>SPF</td>
<td>Sender policy framework</td>
<td>Regra de antispam do MX</td>
</tr>
<tr>
<td>SRV</td>
<td>Service</td>
<td>Controlador de domínio</td>
</tr>
<tr>
<td>TXT</td>
<td>Text</td>
<td>Texto ASCII</td>
</tr>
</tbody>
</table>
<p>Existem muitas outras coisas que podemos ainda falar sobre o funcionamento do DNS mas acredito que nesse texto podemos encerrar por aqui a conversa técnica. Espero que tenha conseguido passar uma visão geral sobre algo tão importante em nossa vida digital hoje.</p>
<h1 id="obtendo-um-domínio">Obtendo um domínio</h1>
<p>Existem diversas formas de obter um domínio, no caso de querer um .br recomendo usar o <a href="https://registro.br/">registro.br</a> que é o que faço uso quando preciso. Para outros que não são tenho usado o <a href="http://register.com/">register.com</a> ou o <a href="https://www.namecheap.com/">Namecheap</a>. Não tenho muitas opiniões a respeito disso mas só digo para que você tome cuidado na escolha de onde comprar para saber se a empresa presta um bom serviço em termos de disponibilidade do serviço e suporte. Algumas empresas fazem venda casada de subir um site pronto e domínio para o cliente e quando você decide sair o site do serviço deles a transferência desse DNS pode ser um problema.</p>
<h1 id="implementações">Implementações</h1>
<p>Aqui vou listar algumas opções de serviços de DNS para você administrar seu <code>Authoritative DNS servers</code> ou <code>Local DNS server</code></p>
<h2 id="open-source">Open Source</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/BIND">BIND</a></li>
<li><a href="https://www.powerdns.com/">PowerDNS</a></li>
<li><a href="https://en.wikipedia.org/wiki/Dnsmasq">dnsmasq</a></li>
</ul>
<h2 id="comerciais">Comerciais</h2>
<ul>
<li><a href="https://aws.amazon.com/pt/route53/">Route53</a></li>
<li><a href="https://www.cloudflare.com/pt-br/dns/">Cloudflare</a></li>
<li><a href="https://ns1.com/">ns1</a></li>
</ul>
<h1 id="referências-do-artigo">Referências do artigo</h1>
<ul>
<li>RFC&rsquo;s do DNS:
<ul>
<li><a href="https://www.ietf.org/rfc/rfc1034.txt">https://www.ietf.org/rfc/rfc1034.txt</a></li>
<li><a href="https://www.ietf.org/rfc/rfc1035.txt">https://www.ietf.org/rfc/rfc1035.txt</a></li>
<li><a href="https://en.wikipedia.org/wiki/Domain_Name_System#RFC_documents">https://en.wikipedia.org/wiki/Domain_Name_System#RFC_documents</a></li>
</ul>
</li>
<li>Modelo OSI: <a href="https://pt.wikipedia.org/wiki/Modelo_OSI">https://pt.wikipedia.org/wiki/Modelo_OSI</a></li>
<li>IPv4: <a href="https://pt.wikipedia.org/wiki/IPv4">https://pt.wikipedia.org/wiki/IPv4</a></li>
<li>IPv6: <a href="https://pt.wikipedia.org/wiki/IPv6">https://pt.wikipedia.org/wiki/IPv6</a></li>
<li>Apache: <a href="https://www.apache.org/">https://www.apache.org/</a></li>
<li>NGINX: <a href="https://www.nginx.com/">https://www.nginx.com/</a></li>
<li>HAProxy: <a href="http://www.haproxy.org/">http://www.haproxy.org/</a></li>
<li>Elastic Load Balancing: <a href="https://aws.amazon.com/pt/elasticloadbalancing/">https://aws.amazon.com/pt/elasticloadbalancing/</a></li>
<li>Cloud Load Balancing: <a href="https://cloud.google.com/load-balancing">https://cloud.google.com/load-balancing</a></li>
<li>Load Balancer: <a href="https://azure.microsoft.com/pt-br/services/load-balancer">https://azure.microsoft.com/pt-br/services/load-balancer</a></li>
<li>Consul: <a href="https://www.consul.io/">https://www.consul.io/</a></li>
<li>HashiCorp: <a href="https://www.hashicorp.com/">https://www.hashicorp.com/</a></li>
<li>LinuxTips: <a href="https://www.linuxtips.io/">https://www.linuxtips.io/</a></li>
<li>gethostbyname(): <a href="https://man7.org/linux/man-pages/man3/gethostbyname.3.html">https://man7.org/linux/man-pages/man3/gethostbyname.3.html</a></li>
<li>DHCP: <a href="https://pt.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">https://pt.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol</a></li>
<li>systemd: <a href="https://pt.wikipedia.org/wiki/Systemd">https://pt.wikipedia.org/wiki/Systemd</a></li>
<li>nsswitch: <a href="https://man7.org/linux/man-pages/man5/nsswitch.conf.5.html">https://man7.org/linux/man-pages/man5/nsswitch.conf.5.html</a></li>
<li>man pages: <a href="https://pt.wikipedia.org/wiki/Man_(Unix)">https://pt.wikipedia.org/wiki/Man_(Unix)</a></li>
<li>Banco de dados chave-valor: <a href="https://en.wikipedia.org/wiki/Key%E2%80%93value_database">https://en.wikipedia.org/wiki/Key%E2%80%93value_database</a></li>
<li>HTTP: <a href="https://pt.wikipedia.org/wiki/Hypertext_Transfer_Protocol">https://pt.wikipedia.org/wiki/Hypertext_Transfer_Protocol</a></li>
<li>HTTPS: <a href="https://pt.wikipedia.org/wiki/Hyper_Text_Transfer_Protocol_Secure">https://pt.wikipedia.org/wiki/Hyper_Text_Transfer_Protocol_Secure</a></li>
<li>TCP: <a href="https://pt.wikipedia.org/wiki/Transmission_Control_Protocol">https://pt.wikipedia.org/wiki/Transmission_Control_Protocol</a></li>
<li>UDP: <a href="https://pt.wikipedia.org/wiki/User_Datagram_Protocol">https://pt.wikipedia.org/wiki/User_Datagram_Protocol</a></li>
<li>ISP: <a href="https://pt.wikipedia.org/wiki/Fornecedor_de_acesso_%C3%A0_internet">https://pt.wikipedia.org/wiki/Fornecedor_de_acesso_%C3%A0_internet</a></li>
<li>Github Pages: <a href="https://pages.github.com/">https://pages.github.com/</a></li>
<li>Github: <a href="https://github.com/">https://github.com/</a></li>
<li>AWS: <a href="https://aws.amazon.com/pt/">https://aws.amazon.com/pt/</a></li>
<li>Route53: <a href="https://aws.amazon.com/pt/route53/">https://aws.amazon.com/pt/route53/</a></li>
<li>ngrok: <a href="https://ngrok.com/">https://ngrok.com/</a></li>
<li>Root DNS servers: <a href="https://root-servers.org/">https://root-servers.org/</a></li>
<li>Top-Level Domain servers: <a href="https://www.iana.org/domains/root/db">https://www.iana.org/domains/root/db</a></li>
<li>registro.br: <a href="https://registro.br/">https://registro.br/</a></li>
<li>register.com: <a href="http://register.com/">http://register.com/</a></li>
<li>Namecheap: <a href="https://www.namecheap.com/">https://www.namecheap.com/</a></li>
<li>BIND: <a href="https://en.wikipedia.org/wiki/BIND">https://en.wikipedia.org/wiki/BIND</a></li>
<li>PowerDNS: <a href="https://www.powerdns.com/">https://www.powerdns.com/</a></li>
<li>dnsmasq: <a href="https://en.wikipedia.org/wiki/Dnsmasq">https://en.wikipedia.org/wiki/Dnsmasq</a></li>
<li>Cloudflare: <a href="https://www.cloudflare.com/pt-br/dns/">https://www.cloudflare.com/pt-br/dns/</a></li>
<li>ns1: <a href="https://ns1.com/">https://ns1.com/</a></li>
</ul>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/dns/" rel="tag">dns</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/infraestrutura/" rel="tag">infraestrutura</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="João Maia avatar" src="/img/avatar.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About João Maia</span>
	</div>
	<div class="authorbox__description">
		Pessoa que resolve problemas com o uso de softwares
	</div>
</div>


<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-hugo" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2022 João Maia.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>